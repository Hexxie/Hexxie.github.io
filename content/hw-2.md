Title: Хроники hw: ШИМ
Date: 2021-02-16 20:26
Category: Hardware
Tags: hartdware, stm32, pet project, pwm
Authors: Anastasiia Rusakova
Summary: Борьба за шим

У меня сейчас на самом деле не много периферии. Ладно, по факту у меня есть только светодиод с кнопкой и еще один микроконтроллер, с которым они по spi будут общаться. Все остальное должно приехать завтра.

![PWM]({static}images/hw-2.jpg)

Мне в любом случае нужно будет изменять яркость и цвет, поэтому решила я начать с управлением яркости. А это ШИМ.
Про ШИМ можно посмотреть [здесь.](https://www.youtube.com/watch?v=Xki0CD3uy0Y&t=0s&ab_channel=narodstream)

Я не буду писать туториалы и все такое, просто сдам набор ресурсов, которые я использовала для того чтоб получить результат.

ШИМ делается с помощью аппаратных таймеров. Это я еще с времен атмеги знала. И пошла сразу гуглить.
Нашла статью для stm32 [здесь.](https://istarik.ru/blog/stm32/118.html). Там же есть и ссылки на урок по таймерам. Когда я прочитала эту фразу

> если установить значение предделителя 3600, то таймер будет «тикать» со скоростью 20000 раз в секунду (72МГц / 3600 = 20КГц). То есть он будет доходить до максимального значения (65536) примерно за 3.22 секунды.

То вспомнила свою неудачу с юартом года 2 назад, когда я бросила разработку для микроконтроллеров. Якобы не интересно. И сразу пошла задавать вопрос в чат. 
Мне нужно было узнать как рассчитывается время.

И мне ответили вот так:

> 1/ на частоту (формула выше) * на количество тиков таймера, в примере выше 65536
> Т.Е. 1/20кГц * 65536 грубо

Т.е. если мне дано время, а я хочу рассчитать предделитель - то это можно сделать пропорцией, учитывая что если частота таймера 72кгц, и нужно чтоб счетчик инкрементировался раз в секунду, то предделитель выставляется 72000(если точнее 71999, так как  счёт идёт от 0).

Но я могу быть не права. Я сделала этот вывод на основе ответов в чате.

От теории к практике. Написала я ШИМ по туториалу, а он не работает. Пока не буду сдавать свою шибку =)
Переписала я ШИМ по [видосику](https://www.youtube.com/watch?v=V3tLOhYkJ8w&list=PLJTlt64jBcCuRgAMGImQzxRlYdSKa5Ifk&index=10&ab_channel=narodstream) и он тоже не работает. Пошла перечитала теорию. Не помогло. Уже ближе к вечеру скачала сорсы автора видосика. Смотрю - нигде нет упоминания что он мигает светодиодом. Только счетчик в бесконечном цикле и таймер.

Поехала я в его урок пораньше, там где он светодиоды включал. И, вот же ж магия, пины светодиодов соответствовали пинам каналов таймера, которые настраивались в cube (звучит не понятно, но если посмотреть туториал - все станет на места). Я конечно уже читала про то что таймер подает напряжение на свой пин, но мне хотелось использовать его чисто как таймер, включать светодиод по прерыванию и получать ШИМ. Самое интересное, ни в одном туториале не было уточнения, что **на пине без таймера - шим работать не будет**.

Потом я еще кнопку прилепила. Кнопка квадратная, без опозновательных знаков. И я таки умудрилась поставить ее не той стороной - так что она не работала. Развернула ее на 90 градусов и все ок. Коварная кнопка :D

[А вот и код...](https://github.com/Hexxie/stm32-workaraunds/tree/main/led%20pwm)
