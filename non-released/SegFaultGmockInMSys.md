Title: Dig into hw programming
Date: 2021-02-15 17:02
Category: Software
Tags: windows, msys, tests, unittest, googletest, gmock, gtest
Authors: Anastasiia Rusakova
Summary: Segmentation fault при запуске тестов с gmock

//Тут нужно поискать цитату
з дня боли и страданий -
и я знаю google mock
(с) Я

Решила тут описать свой путь проб и ошибок в освоении gmock в связке с msys.
В кратце:

gmock - часть гуглового фреймворка, который позволяет тестить "поведение системы". Ну а если по-понятному, можно протестить что функция выполняет другие функции (типа поведение).

msys - окружение с набором gnu тулов (например gcc, make и т.д. свойственные posix операционкам).

Задача связанная с моками приехала ко мне по работе. Здесь сишный код просят тестить плюсовым googletest фреймворком. Тесты на плюсах, код на С, вот такие универсальные мы бойцы.
msys изначально на ПК у меня не было и я думала что minGW будет достаточно. Но вторым требованием работы был lcov и я отправилась гуглить.

lcov нужно было ставить в msys окружение. Основной пакет-менеджер в msys это pacman. И я такая "оо archlinux! А арчлинукс я люблю :)". И поставила я все: make, cmake, lcov. Потом руцями скачала googletest, собрала, подкинула в либы, порадовалась за то что я такая молодец. Ах, еще статью накатала в рабочую конфлю, как правильно тесты ставить и энвайрмент настраивать.

Первая ошибка: Поспеши - людей насмеши.

Пишу я тесты, радуюсь. Поинтеры на статики леплю во всю (за эту фразу чувствую в меня точно полетят помидоры от помидоров :D). Тесты ж, надо покрыть по максимуму. И тут начались воидовские коллбеки, которые вызывают водовские функции. Ну и как это тестить? Ага! Я знаю. Есть же google mock и соседний проект, который моки эти и лепит (можно подсмотреть).
В общем, повторила я мок, а он не работает. Segmentation fault на EXPECT_CALL, gdb не работает - ругается на corrupted stack. Почему? Пошла я гуглить. В гугле толком ничего, советовали только добавить параметр компилятору -DTEST_HAS_PTHREAD=0. Pthread как они есть, у меня тоже не получилось поставить в msys.

Вторая ошибка: сдираешь у коллег - сдирай уже все.

3 дня я мучилась с Segmentation fault. Гуглила не гуглилось, а эмоции накалялись.
Решила я попробовать на линуксе нормальном сделать учебные тесты, может я что-то не знаю, так хоть нормально подебажу.
На этом графомания заканчивается, начнем туториал:

ЧАСТЬ 1: Как работать с google test?


ЧАСТЬ 2: Как поставить тулсет msys (the correct way)


На этом все. Пошла я переписывать статью на рабочей конфле, а то еще коллеги потом помидорами закидают.